{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block css %}
    <!-- Include Quill stylesheet -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <!-- Include Quill library -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
{% endblock %}

{% block content %}

<div class="px-4 py-5 my-5 text-center">
  <img class="d-block mx-auto mb-4" src="{{masjid.masjid_Logo.url}}" alt="" width="80" height="80">
  <h1 class="text-2xl">{{masjid.masjid_Name|title}} Profile Edit Page</h1>
  
</div>

<div class="container">

  <form method="post" enctype="multipart/form-data" class="space-y-4">
    {% csrf_token %}
    
    <!-- Hidden field for weekly schedule -->
    {{ form.weekly_schedule }}

    <!-- DaisyUI Accordion -->
    <div class="join join-vertical w-full">
        <!-- Profile Information Section -->
        <div class="collapse collapse-arrow join-item border border-accent">
            <input type="radio" name="accordion" aria-label="Profile Information" checked />
            <div class="collapse-title text-xl font-medium">
                Profile Information
            </div>
            <div class="collapse-content">
                <div class="space-y-4">
                    <!-- Masjid Name -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Masjid Name</span>
                        </label>
                        {{ form.masjid_Name|add_class:"input input-bordered w-full" }}
                    </div>

                    <!-- Masjid Logo -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Masjid Logo</span>
                        </label>
                        <div class="flex items-center gap-2">
                            {% if masjid.masjid_Logo %}
                                <img src="{{ masjid.masjid_Logo.url }}" width="40px" alt="Masjid Logo">
                            {% endif %}
                            {{ form.masjid_Logo|add_class:"file-input file-input-bordered w-full" }}
                        </div>
                    </div>

                    <!-- About Masjid -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">About Masjid</span>
                        </label>
                        <div id="editor" class="quill-editor">{{ form.about.value|safe }}</div>
                        <textarea id="content" name="content" style="display: none;">{{ form.about.value|safe }}</textarea>
                    </div>

                    <!-- Address -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">First Line of Address</span>
                        </label>
                        {{ form.address1|add_class:"input input-bordered w-full" }}
                    </div>

                    <!-- Town, City, Country, Postcode -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Town</span>
                            </label>
                            {{ form.town|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">City</span>
                            </label>
                            {{ form.city|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Country</span>
                            </label>
                            {{ form.country|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Postcode</span>
                            </label>
                            {{ form.postcode|add_class:"input input-bordered w-full" }}
                        </div>
                    </div>

                    <!-- What3Words -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">What3Words</span>
                        </label>
                        {{ form.what3words|add_class:"input input-bordered w-full" }}
                    </div>

                    <!-- Imam -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Imam</span>
                        </label>
                        {{ form.imam|add_class:"input input-bordered w-full" }}
                    </div>

                    <!-- Contact Information -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Landline</span>
                            </label>
                            {{ form.landline|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Mobile</span>
                            </label>
                            {{ form.mobile|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Email</span>
                            </label>
                            {{ form.email|add_class:"input input-bordered w-full" }}
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Social Media -->
                    <h2 class="text-lg font-semibold">Social Media</h2>
                    <div class="space-y-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Facebook</span>
                            </label>
                            {{ form.facebook|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Instagram</span>
                            </label>
                            {{ form.instagram|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">YouTube</span>
                            </label>
                            {{ form.youtube|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Twitter</span>
                            </label>
                            {{ form.twitter|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Telegram</span>
                            </label>
                            {{ form.telegram|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">TikTok</span>
                            </label>
                            {{ form.tiktok|add_class:"input input-bordered w-full" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Schedule Section -->
        <div class="collapse collapse-arrow join-item border border-info">
            <input type="radio" name="accordion" aria-label="Weekly Schedule" />
            <div class="collapse-title text-xl font-medium">
                Weekly Schedule - Days & Prayers with Jamaah
            </div>
            <div class="collapse-content">
                <div class="space-y-6">
                    <div class="alert alert-info">
                        <div>
                            <span>Select which days the centre is open and which prayers will have jamaah times on each day.</span>
                        </div>
                    </div>
                    
                    <!-- Days Grid -->
                    <div id="schedule-container" class="space-y-4">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Prayer Calculation Methods Section -->
        <div class="collapse collapse-arrow join-item border border-primary">
            <input type="radio" name="accordion" aria-label="Prayer Calculation Methods" />
            <div class="collapse-title text-xl font-medium">
                Prayer Calculation Methods
            </div>
            <div class="collapse-content">
                <div class="space-y-4">
                    <!-- Help Links -->
                    <div class="alert alert-warning">
                        <div>
                            <span>For help with calculation methods, <a href="http://praytimes.org/wiki/Prayer_Times_Calculation" target="_blank" class="link">click here</a>.</span>
                            <br>
                            <span>For an explanation of the shafaq (twilight) calculation, <a href="https://www.msofg.org/2018/12/how-do-we-calculate-our-prayers-time/" target="_blank" class="link">click here</a>.</span>
                        </div>
                    </div>

                    <!-- Method, Shafaq, School -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Method</span>
                            </label>
                            {{ form.method|add_class:"select select-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Shafaq</span>
                            </label>
                            {{ form.shafaq|add_class:"select select-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">School</span>
                            </label>
                            {{ form.school|add_class:"select select-bordered w-full" }}
                        </div>
                    </div>

                    <!-- Latitude and Longitude -->
                    <div class="alert alert-info">
                        <div>
                            <span>To work out longitude & latitude, <a href="https://www.latlong.net/" target="_blank" class="link">click here</a>.</span>
                        </div>
                    </div>

                    <!-- Jamaah Minutes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Latitude</span>
                            </label>
                            {{ form.latitude|add_class:"input input-bordered w-full" }}
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Longitude</span>
                            </label>
                            {{ form.longitude|add_class:"input input-bordered w-full" }}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div class="form-control">
                        <label class="label">
                            <span class="label-text">Fajr Jamaah Minutes</span>
                        </label>
                        {{ form.fajr_jamaah_minutes|add_class:"select" }}
                      </div>
                      <div class="form-control">
                        <label class="label">
                            <span class="label-text">Dhuhr Jamaah Minutes</span>
                        </label>
                        {{ form.dhuhr_jamaah_minutes|add_class:"select" }}
                      </div>
                      <div class="form-control">
                          <label class="label">
                              <span class="label-text">Asr Jamaah Minutes</span>
                          </label>
                          {{ form.asr_jamaah_minutes|add_class:"select" }}
                      </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="form-control">
                        <label class="label">
                            <span class="label-text">Maghrib Jamaah Minutes</span>
                        </label>
                          {{ form.maghrib_jamaah_minutes|add_class:"select" }}
                      </div>
                      <div class="form-control">
                          <label class="label">
                              <span class="label-text">Isha Jamaah Minutes</span>
                          </label>
                          {{ form.isha_jamaah_minutes|add_class:"select" }}
                      </div>

                    </div>
                    
                    
                </div>
            </div>
        </div>

        <!-- Site Styling Section -->
        <div class="collapse collapse-arrow join-item border border-secondary">
            <input type="radio" name="accordion" aria-label="Site Styling" />
            <div class="collapse-title text-xl font-medium">
                Site Styling
            </div>
            <div class="collapse-content">
                <div class="space-y-4">
                    <!-- Theme Choice -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Theme Choice</span>
                        </label>
                        {{ form.theme_choice|add_class:"select select-bordered w-full" }}
                    </div>

                    <!-- Masjid Photo -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Masjid Photo</span>
                        </label>
                        {% if masjid.masjid_Photo %}
                            <img src="{{ masjid.masjid_Photo.url }}" width="100px" alt="Masjid Photo">
                        {% endif %}
                        {{ form.masjid_Photo|add_class:"file-input file-input-bordered w-full" }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Button -->
    <div class="mt-6">
        <input type="submit" value="Save Profile" class="btn btn-primary w-full">
    </div>
</form>
</div>
<script src="{% static 'js/quill_editor_settings.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const daysOfWeek = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const prayers = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
    const scheduleInput = document.querySelector('input[name="weekly_schedule"]');
    const container = document.getElementById('schedule-container');
    
    // Parse existing schedule from the form field (from database)
    let schedule = {};
    try {
        const existingValue = scheduleInput.value;
        if (existingValue && existingValue.trim() !== '') {
            schedule = JSON.parse(existingValue);
        } else {
            throw new Error('No existing schedule');
        }
    } catch (e) {
        // Use default if parsing fails
        schedule = {};
        daysOfWeek.forEach(day => {
            schedule[day] = {
                open: true,
                fajr_jamaah: true,
                dhuhr_jamaah: true,
                asr_jamaah: true,
                maghrib_jamaah: true,
                isha_jamaah: true
            };
        });
    }
    
    // Build UI for each day
    daysOfWeek.forEach(day => {
        const dayData = schedule[day] || { open: true, fajr_jamaah: true, dhuhr_jamaah: true, asr_jamaah: true, maghrib_jamaah: true, isha_jamaah: true };
        
        const dayDiv = document.createElement('div');
        dayDiv.className = 'card bg-base-100 border border-gray-300 p-4';
        dayDiv.dataset.day = day;
        
        let html = `
            <h3 class="text-lg font-semibold capitalize mb-3">${day}</h3>
            <div class="form-control mb-3">
                <label class="label cursor-pointer">
                    <span class="label-text font-medium">Centre Open on ${day.charAt(0).toUpperCase() + day.slice(1)}</span>
                    <input type="checkbox" class="checkbox day-open-checkbox" data-day="${day}" ${dayData.open ? 'checked' : ''} />
                </label>
            </div>
            <div class="divider my-2"></div>
            <div class="space-y-2 prayers-section">
                <p class="text-sm font-semibold text-gray-600">Prayers with Jamaah</p>
        `;
        
        prayers.forEach(prayer => {
            const prayerKey = `${prayer}_jamaah`;
            const isChecked = dayData[prayerKey] || false;
            html += `
                <label class="label cursor-pointer pl-4">
                    <span class="label-text capitalize">${prayer}</span>
                    <input type="checkbox" class="checkbox prayer-jamaah-checkbox" data-day="${day}" data-prayer="${prayer}" ${isChecked ? 'checked' : ''} />
                </label>
            `;
        });
        
        html += '</div>';
        dayDiv.innerHTML = html;
        container.appendChild(dayDiv);
    });
    
    // Event listeners
    document.querySelectorAll('.day-open-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const day = this.dataset.day;
            const dayCard = document.querySelector(`[data-day="${day}"]`);
            
            if (!this.checked) {
                // If day is unchecked, uncheck all prayer jamaah for that day
                dayCard.querySelectorAll('.prayer-jamaah-checkbox').forEach(prayerCheckbox => {
                    prayerCheckbox.checked = false;
                });
            } else {
                // If day is checked, check all prayer jamaah for that day
                dayCard.querySelectorAll('.prayer-jamaah-checkbox').forEach(prayerCheckbox => {
                    prayerCheckbox.checked = true;
                });
            }
            
            updateSchedule();
        });
    });
    
    document.querySelectorAll('.prayer-jamaah-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateDayCheckboxState(this.dataset.day);
            updateSchedule();
        });
    });
    
    function updateDayCheckboxState(day) {
        const dayCard = document.querySelector(`[data-day="${day}"]`);
        const dayCheckbox = dayCard.querySelector('.day-open-checkbox');
        const prayerCheckboxes = dayCard.querySelectorAll('.prayer-jamaah-checkbox');
        
        const checkedCount = Array.from(prayerCheckboxes).filter(cb => cb.checked).length;
        const totalCount = prayerCheckboxes.length;
        
        if (checkedCount === 0) {
            // No prayers selected - uncheck the day
            dayCheckbox.checked = false;
            dayCheckbox.indeterminate = false;
            dayCheckbox.classList.remove('checkbox-warning');
        } else if (checkedCount === totalCount) {
            // All prayers selected - fully check the day
            dayCheckbox.checked = true;
            dayCheckbox.indeterminate = false;
            dayCheckbox.classList.remove('checkbox-warning');
        } else {
            // Some prayers selected - partial state
            dayCheckbox.checked = true;
            dayCheckbox.indeterminate = true;
            dayCheckbox.classList.add('checkbox-warning');
        }
    }
    
    // Initialize day checkbox states based on current prayer selections
    daysOfWeek.forEach(day => {
        updateDayCheckboxState(day);
    });
    
    function updateSchedule() {
        const newSchedule = {};
        
        daysOfWeek.forEach(day => {
            const dayCard = document.querySelector(`[data-day="${day}"]`);
            const isOpen = dayCard.querySelector('.day-open-checkbox').checked;
            
            newSchedule[day] = {
                open: isOpen
            };
            
            prayers.forEach(prayer => {
                const prayerCheckbox = dayCard.querySelector(`.prayer-jamaah-checkbox[data-prayer="${prayer}"]`);
                newSchedule[day][`${prayer}_jamaah`] = prayerCheckbox.checked;
            });
        });
        
        scheduleInput.value = JSON.stringify(newSchedule);
    }
    
    // Initialize schedule value
    updateSchedule();
});
</script>
{% endblock %}
